{
  "{\"filename\":\"/app/index.js\",\"env\":{},\"retainLines\":false,\"highlightCode\":true,\"suppressDeprecationMessages\":false,\"presets\":[],\"plugins\":[[[],{\"loose\":false,\"spec\":false}],[[],null],[[],null],[[],{\"spec\":false}],[[],null],[[],{\"loose\":false}],[[],null],[[],null],[[],null],[[],{\"loose\":false}],[[],{\"loose\":false}],[[],null],[[],null],[[],null],[[],{\"loose\":false}],[[],null],[[],{\"loose\":false}],[[],null],[[],null],[[],{\"loose\":false}],[[],{\"async\":false,\"asyncGenerators\":false}]],\"ignore\":[],\"code\":true,\"metadata\":true,\"ast\":true,\"comments\":true,\"compact\":\"auto\",\"minified\":false,\"sourceRoot\":\"/app\",\"babelrc\":true,\"sourceType\":\"module\",\"moduleIds\":false,\"passPerPreset\":false,\"parserOpts\":false,\"generatorOpts\":false}:6.26.3": {
    "metadata": {
      "usedHelpers": [],
      "marked": [],
      "modules": {
        "imports": [],
        "exports": {
          "exported": [],
          "specifiers": []
        }
      }
    },
    "options": {
      "filename": "/app/index.js",
      "filenameRelative": "/app/index.js",
      "env": {},
      "retainLines": false,
      "highlightCode": true,
      "suppressDeprecationMessages": false,
      "presets": [],
      "plugins": [
        [
          [],
          {
            "loose": false,
            "spec": false
          }
        ],
        [
          [],
          null
        ],
        [
          [],
          null
        ],
        [
          [],
          {
            "spec": false
          }
        ],
        [
          [],
          null
        ],
        [
          [],
          {
            "loose": false
          }
        ],
        [
          [],
          null
        ],
        [
          [],
          null
        ],
        [
          [],
          null
        ],
        [
          [],
          {
            "loose": false
          }
        ],
        [
          [],
          {
            "loose": false
          }
        ],
        [
          [],
          null
        ],
        [
          [],
          null
        ],
        [
          [],
          null
        ],
        [
          [],
          {
            "loose": false
          }
        ],
        [
          [],
          null
        ],
        [
          [],
          {
            "loose": false
          }
        ],
        [
          [],
          null
        ],
        [
          [],
          null
        ],
        [
          [],
          {
            "loose": false
          }
        ],
        [
          [],
          {
            "async": false,
            "asyncGenerators": false
          }
        ]
      ],
      "ignore": [],
      "code": true,
      "metadata": true,
      "ast": false,
      "comments": true,
      "compact": "auto",
      "minified": false,
      "sourceMaps": "both",
      "sourceMapTarget": "index.js",
      "sourceFileName": "index.js",
      "sourceRoot": "/app",
      "babelrc": false,
      "sourceType": "module",
      "moduleRoot": "/app",
      "moduleIds": false,
      "passPerPreset": false,
      "parserOpts": false,
      "generatorOpts": false,
      "basename": "index"
    },
    "ignored": false,
    "code": "// https://developers.facebook.com/docs/messenger-platform/getting-started/webhook-setup/\n// https://developers.facebook.com/docs/messenger-platform/getting-started/app-setup\n// https://developers.facebook.com/docs/messenger-platform/getting-started/quick-start\n\n\"use strict\";\n\n// Imports dependencies and set up http server\n\nvar express = require(\"express\"),\n    bodyParser = require(\"body-parser\"),\n    app = express().use(bodyParser.json()); // creates express http server\nvar request = require(\"request\");\n\n// import { checkUser, createUser } from './DBConn';\n\n// Get page access token\nvar PAGE_ACCESS_TOKEN = process.env.PAGE_ACCESS_TOKEN;\n\n// Sets server port and logs message on success\napp.listen(3000, function () {\n  return console.log(\"webhook is listening\");\n});\n\n// Adds support for GET requests to our webhook\napp.get(\"/webhook\", function (req, res) {\n  var VERIFY_TOKEN = process.env.VERIFY_TOKEN;\n\n  // Parse the query params\n  var mode = req.query[\"hub.mode\"];\n  var token = req.query[\"hub.verify_token\"];\n  var challenge = req.query[\"hub.challenge\"];\n\n  // Checks if a token and mode is in the query string of the request\n  if (mode && token) {\n    // Checks the mode and token sent is correct\n    if (mode === \"subscribe\" && token === VERIFY_TOKEN) {\n      // Responds with the challenge token from the request\n      console.log(\"WEBHOOK_VERIFIED\");\n      res.status(200).send(challenge);\n    } else {\n      // Responds with '403 Forbidden' if verify tokens do not match\n      res.sendStatus(403);\n    }\n  }\n});\n\n// Creates the endpoint for our webhook\napp.post(\"/webhook\", function (req, res) {\n  var body = req.body;\n\n  // Checks this is an event from a page subscription\n  if (body.object === \"page\") {\n    // Iterates over each entry - there may be multiple if batched\n    body.entry.forEach(function (entry) {\n      // Gets the message. entry.messaging is an array, but\n      // will only ever contain one message, so we get index 0\n      var webhook_event = entry.messaging[0];\n      // console.log(webhook_event);\n\n      // Get the sender PSID\n      var sender_psid = webhook_event.sender.id;\n      // console.log(\"Sender PSID: \" + sender_psid);\n\n      // Check if the event is a message or postback and\n      // pass the event to the appropriate handler function\n      if (webhook_event.message) {\n        // getName(sender_psid, function(response){\n        //     checkUser(sender_psid,response);\n        // });\n        handleMessage(sender_psid, webhook_event.message);\n      } else if (webhook_event.postback) {\n        handlePostback(sender_psid, webhook_event.postback);\n      }\n    });\n\n    // Returns a '200 OK' response to all requests\n    res.status(200).send(\"EVENT_RECEIVED\");\n  } else {\n    // Returns a '404 Not Found' if event is not from a page subscription\n    res.sendStatus(404);\n  }\n});\n\n// Gets users name from facebook graph api\n// function getName(sender_psid,callback){\n//     var name = \"Empty\";\n//     request({\n//         url:\"https://graph.facebook.com/v3.3/\" + sender_psid,\n//         qs:{\n//             access_token: PAGE_ACCESS_TOKEN,\n//             fields: \"first_name\",\n//         },\n//         method:\"GET\"\n//     }, function(error,response,body){\n//         if (error){\n//             console.log(error)\n//         }else{\n//             var bodyObj = JSON.parse(body);\n//             name = bodyObj.first_name;\n//             console.log(\"Name: \" + name);\n//             return callback(name)\n//         }\n//     });\n//     return name;\n// }\n\n// Handles messages events\nfunction handleMessage(sender_psid, received_message) {\n  var response = void 0;\n\n  // Check if the message contains text\n  if (received_message.text) {\n    console.log(\"Received message: \\\"\" + received_message.text + \"\\\"\");\n\n    response = processMessage(sender_psid, received_message);\n    // Default response (for debugging)\n    // Create the payload for a basic text message\n    // response = {\n    //   text: `You sent the message: \"${received_message.text}\".`\n    // };\n  } else {\n    response = defaultResponse();\n    //     // Gets the URL of the message attachment\n    //     let attachment_url = received_message.attachments[0].payload.url;\n  }\n\n  // Sends the response message\n  callSendAPI(sender_psid, response);\n}\n\nfunction processMessage(sender_psid, message) {\n  // NLP: https://developers.facebook.com/docs/messenger-platform/built-in-nlp\n  var entities = message.nlp[\"entities\"];\n\n  // Object.keys(entities).forEach(key => {\n  //   console.log(key);\n  //   console.log(entities[key]);\n  // });\n\n  // Check greeting\n  var is_greeting = entities[\"greetings\"] != null && entities[\"greetings\"][0][\"confidence\"] > 0.8; // Greeting threshold set to 0.8\n\n  // Retrieve first intent object\n  var intent = entities[\"intent\"][0];\n\n  if (intent[\"confidence\"] > 0.5) {\n    // Process intent\n    var intent_parts = intent[\"value\"].split(\"_\");\n    var intent_category = intent_parts[0];\n    var response = null;\n\n    if (intent_category === \"recommendation\") {\n      // Handle recommendation\n      // response = generateResponseFromMessage(\n      //   \"Message received is a recommendation message.\"\n      // );\n\n      var product_types = [];\n      if (entities[\"product_type\"]) {\n        console.log(\"Processing product types\");\n        product_types = entities[\"product_type\"].filter(function (obj) {\n          return obj[\"confidence\"] > 0.5;\n        }).map(function (obj) {\n          return obj[\"value\"];\n        });\n      }\n\n      response = generateRecommendationsResponse(product_types);\n    }\n\n    if (intent_category === \"enquiry\") {\n      // Handle enquiry\n      // response = generateResponseFromMessage(\n      //   \"Message received is an enquiry message.\"\n      // );\n\n      var intent_subcategory = intent_parts[1];\n\n      if (intent_subcategory === \"general\") {\n        if (entities[\"profit\"]) {\n          response = generateResponseFromMessage(\"All net revenue earned from the sale of our products and services go towards paying a monthly allowance for our clients' work, as well as their lunch expenses while undergoing training.\");\n        } else if (entities[\"manufacturer\"]) {\n          response = generateResponseFromMessage(\"We support adults with intellectual disabilities. We started a range of social enterprise projects to provide alternative work engagement for our adult trainees.\");\n        } else if (entities[\"products\"]) {\n          response = generateResponseFromMessage(\"We sell craft and baker goods.\");\n        }\n      } else if (intent_subcategory === \"delivery\") {\n        // Check for estimated arrival entity\n        if (entities[\"estimated_arrival\"]) {\n          response = generateResponseFromMessage(\"The average delivery time takes 5-7 working days. Your ordered was sent on 17 February. It is estimated to arrive on {sent date + 7 working day}.\");\n        } else if (entities[\"cost\"]) {\n          response = generateResponseFromMessage(\"It is a flat fee of $2 for every order.\");\n        } else if (entities[\"status\"]) {\n          // TODO: Order status\n        } else {\n          response = generateResponseFromMessage(\"We deliver islandwide. The average delivery time takes 5-7 working days.\");\n        }\n      }\n    }\n\n    if (intent_category === \"cart\") {\n      // Handle shopping cart\n      response = generateResponseFromMessage(\"Message received is a cart message.\");\n\n      var _intent_subcategory = intent_parts[1];\n      if (_intent_subcategory === \"add\" && entities[\"product\"]) {\n        var product_name = entities[\"product\"][0][\"value\"];\n        var quantity = entities[\"number\"] ? entities[\"number\"][0][\"value\"] : 1;\n        response = generateAddCartResponse(sender_psid, product_name, quantity);\n      } else if (_intent_subcategory === \"view\") {\n        response = generateViewCartResponse(sender_psid);\n      }\n    }\n\n    if (response === null) {\n      return defaultResponse();\n    }\n\n    return response;\n  } else if (is_greeting) {\n    // Message has no intent, just greeting\n    return generateResponseFromMessage(\"Hi there! Welcome to MINDS. How can I help you?\");\n  }\n\n  Object.keys(entities).forEach(function (key) {\n    console.log(key);\n    console.log(entities[key]);\n  });\n\n  return defaultResponse();\n}\n\nfunction defaultResponse() {\n  return generateResponseFromMessage(\"We could not understand your message. Kindly rephrase your message and send us again.\");\n}\n\nfunction generateResponseFromMessage(message) {\n  return {\n    text: message\n  };\n}\n\nfunction generateRecommendationsTemplateElements(products) {\n  var template_elements = products.map(function (product) {\n    return {\n      title: product[\"name\"],\n      subtitle: \"$\" + product[\"price\"],\n      image_url: product[\"url\"],\n      buttons: [{\n        type: \"postback\",\n        title: \"Learn More\",\n        payload: \"enquiry_product \" + product[\"name\"]\n      }, {\n        type: \"postback\",\n        title: \"Add to Cart\",\n        payload: \"cart_add \" + product[\"name\"]\n      }]\n    };\n  });\n  return template_elements;\n}\n\nfunction generateRecommendationsResponse(product_types) {\n  var response = {\n    attachment: {\n      type: \"template\",\n      payload: {\n        template_type: \"generic\",\n        elements: generateRecommendationsTemplateElements([{\n          id: 1,\n          name: \"Dark Chocolate Oatmeal Cookies\",\n          price: 3.5,\n          url: \"https://static.wixstatic.com/media/768979_3fccb2bb837a44caa80bb4fc5dddd119~mv2_d_1800_1800_s_2.jpg\",\n          attribute: {\n            allegens: ['eggs', 'nut'],\n            colour: null\n\n          }\n        }, {\n          id: 2,\n          name: \"Cranberry Sweetheart Cookies (Eggless)\",\n          price: 3.5,\n          url: \"https://static.wixstatic.com/media/768979_3fccb2bb837a44caa80bb4fc5dddd119~mv2_d_1800_1800_s_2.jpg\"\n        }, {\n          id: 3,\n          name: \"Earl Grey Sunflower Seeds Cookies\",\n          price: 3.5,\n          url: \"https://static.wixstatic.com/media/768979_3fccb2bb837a44caa80bb4fc5dddd119~mv2_d_1800_1800_s_2.jpg\"\n        }])\n      }\n    }\n  };\n  return response;\n}\n\nfunction generateAddCartResponse(sender_psid, product_name, quantity) {\n  // TODO: Add product to cart in db\n\n  return {\n    text: \"Added \" + quantity + \" \" + product_name + \" to cart.\",\n    quick_replies: [{\n      \"content_type\": \"text\",\n      \"title\": \"View Cart\",\n      \"payload\": \"cart_view\"\n    }, {\n      \"content_type\": \"text\",\n      \"title\": \"Checkout\",\n      \"payload\": \"checkout\"\n    }]\n  };\n}\n\nfunction generateCartTemplateElements(products) {\n  var template_elements = products.map(function (product) {\n    return {\n      title: product[\"name\"],\n      subtitle: \"Qty: \" + product[\"quantity\"] + \" ($\" + product[\"price\"] + \" each)\",\n      image_url: product[\"url\"],\n      buttons: [{\n        type: \"postback\",\n        title: \"Add 1\",\n        payload: \"cart_add \" + product[\"name\"]\n      }, {\n        type: \"postback\",\n        title: \"Remove All\",\n        payload: \"cart_remove \" + product[\"name\"]\n      }]\n    };\n  });\n  return template_elements;\n}\n\nfunction generateViewCartResponse(product_types) {\n  var response = {\n    attachment: {\n      type: \"template\",\n      payload: {\n        template_type: \"generic\",\n        elements: generateCartTemplateElements([{\n          id: 1,\n          name: \"Dark Chocolate Oatmeal Cookies\",\n          price: 3.5,\n          url: \"https://static.wixstatic.com/media/768979_3fccb2bb837a44caa80bb4fc5dddd119~mv2_d_1800_1800_s_2.jpg\",\n          quantity: 1\n        }, {\n          id: 2,\n          name: \"Cranberry Sweetheart Cookies (Eggless)\",\n          price: 3.5,\n          url: \"https://static.wixstatic.com/media/768979_3fccb2bb837a44caa80bb4fc5dddd119~mv2_d_1800_1800_s_2.jpg\",\n          quantity: 2\n        }, {\n          id: 3,\n          name: \"Earl Grey Sunflower Seeds Cookies\",\n          price: 3.5,\n          url: \"https://static.wixstatic.com/media/768979_3fccb2bb837a44caa80bb4fc5dddd119~mv2_d_1800_1800_s_2.jpg\",\n          quantity: 1\n        }])\n      }\n    }\n  };\n  return response;\n}\n\n// Handles messaging_postbacks events\nfunction handlePostback(sender_psid, received_postback) {\n  var response = void 0;\n\n  // Get the payload for the postback\n  var payload = received_postback.payload;\n  console.log(\"Received postback: \\\"\" + payload + \"\\\"\");\n\n  var postback_intent = payload.split(\" \")[0];\n  var postback_content = payload.substring(payload.indexOf(\" \") + 1, payload.length);\n\n  // Set the response based on the postback intent\n  if (postback_intent === \"cart_add\") {\n    // Add to cart\n    response = generateAddCartResponse(sender_psid, postback_content, 1);\n  } else if (postback_intent === \"cart_view\") {\n    response = generateViewCartResponse(sender_psid);\n  } else if (postback_intent === \"enquiry_product\") {\n    response = {\n      text: \"What would you like to know about our \" + postback_content + \"?\"\n    };\n  }\n\n  if (response == null) {\n    response = defaultResponse();\n  }\n\n  // Send the message to acknowledge the postback\n  callSendAPI(sender_psid, response);\n}\n\n// Sends response messages via the Send API\nfunction callSendAPI(sender_psid, response) {\n  // Construct the message body\n  var request_body = {\n    recipient: {\n      id: sender_psid\n    },\n    message: response\n  };\n\n  // Send the HTTP request to the Messenger Platform\n  request({\n    uri: \"https://graph.facebook.com/v2.6/me/messages\",\n    qs: { access_token: PAGE_ACCESS_TOKEN },\n    method: \"POST\",\n    json: request_body\n  }, function (err, res, body) {\n    if (!err) {\n      console.log(\"Message sent!\");\n    } else {\n      console.error(\"Unable to send message:\" + err);\n    }\n  });\n}\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbImV4cHJlc3MiLCJyZXF1aXJlIiwiYm9keVBhcnNlciIsImFwcCIsInVzZSIsImpzb24iLCJyZXF1ZXN0IiwiUEFHRV9BQ0NFU1NfVE9LRU4iLCJwcm9jZXNzIiwiZW52IiwibGlzdGVuIiwiY29uc29sZSIsImxvZyIsImdldCIsInJlcSIsInJlcyIsIlZFUklGWV9UT0tFTiIsIm1vZGUiLCJxdWVyeSIsInRva2VuIiwiY2hhbGxlbmdlIiwic3RhdHVzIiwic2VuZCIsInNlbmRTdGF0dXMiLCJwb3N0IiwiYm9keSIsIm9iamVjdCIsImVudHJ5IiwiZm9yRWFjaCIsIndlYmhvb2tfZXZlbnQiLCJtZXNzYWdpbmciLCJzZW5kZXJfcHNpZCIsInNlbmRlciIsImlkIiwibWVzc2FnZSIsImhhbmRsZU1lc3NhZ2UiLCJwb3N0YmFjayIsImhhbmRsZVBvc3RiYWNrIiwicmVjZWl2ZWRfbWVzc2FnZSIsInJlc3BvbnNlIiwidGV4dCIsInByb2Nlc3NNZXNzYWdlIiwiZGVmYXVsdFJlc3BvbnNlIiwiY2FsbFNlbmRBUEkiLCJlbnRpdGllcyIsIm5scCIsImlzX2dyZWV0aW5nIiwiaW50ZW50IiwiaW50ZW50X3BhcnRzIiwic3BsaXQiLCJpbnRlbnRfY2F0ZWdvcnkiLCJwcm9kdWN0X3R5cGVzIiwiZmlsdGVyIiwib2JqIiwibWFwIiwiZ2VuZXJhdGVSZWNvbW1lbmRhdGlvbnNSZXNwb25zZSIsImludGVudF9zdWJjYXRlZ29yeSIsImdlbmVyYXRlUmVzcG9uc2VGcm9tTWVzc2FnZSIsInByb2R1Y3RfbmFtZSIsInF1YW50aXR5IiwiZ2VuZXJhdGVBZGRDYXJ0UmVzcG9uc2UiLCJnZW5lcmF0ZVZpZXdDYXJ0UmVzcG9uc2UiLCJPYmplY3QiLCJrZXlzIiwia2V5IiwiZ2VuZXJhdGVSZWNvbW1lbmRhdGlvbnNUZW1wbGF0ZUVsZW1lbnRzIiwicHJvZHVjdHMiLCJ0ZW1wbGF0ZV9lbGVtZW50cyIsInRpdGxlIiwicHJvZHVjdCIsInN1YnRpdGxlIiwiaW1hZ2VfdXJsIiwiYnV0dG9ucyIsInR5cGUiLCJwYXlsb2FkIiwiYXR0YWNobWVudCIsInRlbXBsYXRlX3R5cGUiLCJlbGVtZW50cyIsIm5hbWUiLCJwcmljZSIsInVybCIsImF0dHJpYnV0ZSIsImFsbGVnZW5zIiwiY29sb3VyIiwicXVpY2tfcmVwbGllcyIsImdlbmVyYXRlQ2FydFRlbXBsYXRlRWxlbWVudHMiLCJyZWNlaXZlZF9wb3N0YmFjayIsInBvc3RiYWNrX2ludGVudCIsInBvc3RiYWNrX2NvbnRlbnQiLCJzdWJzdHJpbmciLCJpbmRleE9mIiwibGVuZ3RoIiwicmVxdWVzdF9ib2R5IiwicmVjaXBpZW50IiwidXJpIiwicXMiLCJhY2Nlc3NfdG9rZW4iLCJtZXRob2QiLCJlcnIiLCJlcnJvciJdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBOztBQUVBOztBQUVBOztBQUNBLElBQU1BLFVBQVVDLFFBQVEsU0FBUixDQUFoQjtBQUFBLElBQ0VDLGFBQWFELFFBQVEsYUFBUixDQURmO0FBQUEsSUFFRUUsTUFBTUgsVUFBVUksR0FBVixDQUFjRixXQUFXRyxJQUFYLEVBQWQsQ0FGUixDLENBRTBDO0FBQzFDLElBQU1DLFVBQVVMLFFBQVEsU0FBUixDQUFoQjs7QUFFQTs7QUFFQTtBQUNBLElBQU1NLG9CQUFvQkMsUUFBUUMsR0FBUixDQUFZRixpQkFBdEM7O0FBRUE7QUFDQUosSUFBSU8sTUFBSixDQUFXLElBQVgsRUFBaUI7QUFBQSxTQUFNQyxRQUFRQyxHQUFSLENBQVksc0JBQVosQ0FBTjtBQUFBLENBQWpCOztBQUVBO0FBQ0FULElBQUlVLEdBQUosQ0FBUSxVQUFSLEVBQW9CLFVBQUNDLEdBQUQsRUFBTUMsR0FBTixFQUFjO0FBQ2hDLE1BQUlDLGVBQWVSLFFBQVFDLEdBQVIsQ0FBWU8sWUFBL0I7O0FBRUE7QUFDQSxNQUFJQyxPQUFPSCxJQUFJSSxLQUFKLENBQVUsVUFBVixDQUFYO0FBQ0EsTUFBSUMsUUFBUUwsSUFBSUksS0FBSixDQUFVLGtCQUFWLENBQVo7QUFD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QXlCUSxRQUF6QjtBQUNEOztBQUVEO0FBQ0EsU0FBU0ksV0FBVCxDQUFxQlosV0FBckIsRUFBa0NRLFFBQWxDLEVBQTRDO0FBQzFDO0FBQ0EsTUFBSXFELGVBQWU7QUFDakJDLGVBQVc7QUFDVDVELFVBQUlGO0FBREssS0FETTtBQUlqQkcsYUFBU0s7QUFKUSxHQUFuQjs7QUFPQTtBQUNBakMsVUFDRTtBQUNFd0YsU0FBSyw2Q0FEUDtBQUVFQyxRQUFJLEVBQUVDLGNBQWN6RixpQkFBaEIsRUFGTjtBQUdFMEYsWUFBUSxNQUhWO0FBSUU1RixVQUFNdUY7QUFKUixHQURGLEVBT0UsVUFBQ00sR0FBRCxFQUFNbkYsR0FBTixFQUFXVSxJQUFYLEVBQW9CO0FBQ2xCLFFBQUksQ0FBQ3lFLEdBQUwsRUFBVTtBQUNSdkYsY0FBUUMsR0FBUixDQUFZLGVBQVo7QUFDRCxLQUZELE1BRU87QUFDTEQsY0FBUXdGLEtBQVIsQ0FBYyw0QkFBNEJELEdBQTFDO0FBQ0Q7QUFDRixHQWJIO0FBZUQiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiL2FwcCIsInNvdXJjZXNDb250ZW50IjpbIi8vIGh0dHBzOi8vZGV2ZWxvcGVycy5mYWNlYm9vay5jb20vZG9jcy9tZXNzZW5nZXItcGxhdGZvcm0vZ2V0dGluZy1zdGFydGVkL3dlYmhvb2stc2V0dXAvXG4vLyBodHRwczovL2RldmVsb3BlcnMuZmFjZWJvb2suY29tL2RvY3MvbWVzc2VuZ2VyLXBsYXRmb3JtL2dldHRpbmctc3RhcnRlZC9hcHAtc2V0dXBcbi8vIGh0dHBzOi8vZGV2ZWxvcGVycy5mYWNlYm9vay5jb20vZG9jcy9tZXNzZW5nZXItcGxhdGZvcm0vZ2V0dGluZy1zdGFydGVkL3F1aWNrLXN0YXJ0XG5cblwidXNlIHN0cmljdFwiO1xuXG4vLyBJbXBvcnRzIGRlcGVuZGVuY2llcyBhbmQgc2V0IHVwIGh0dHAgc2VydmVyXG5jb25zdCBleHByZXNzID0gcmVxdWlyZShcImV4cHJlc3NcIiksXG4gIGJvZHlQYXJzZXIgPSByZXF1aXJlKFwiYm9keS1wYXJzZXJcIiksXG4gIGFwcCA9IGV4cHJlc3MoKS51c2UoYm9keVBhcnNlci5qc29uKCkpOyAvLyBjcmVhdGVzIGV4cHJlc3MgaHR0cCBzZXJ2ZXJcbmNvbnN0IHJlcXVlc3QgPSByZXF1aXJlKFwicmVxdWVzdFwiKTtcblxuLy8gaW1wb3J0IHsgY2hlY2tVc2VyLCBjcmVhdGVVc2VyIH0gZnJvbSAnLi9EQkNvbm4nO1xuXG4vLyBHZXQgcGFnZSBhY2Nlc3MgdG9rZW5cbmNvbnN0IFBBR0VfQUNDRVNTX1RPS0VOID0gcHJvY2Vzcy5lbnYuUEFHRV9BQ0NFU1NfVE9LRU47XG5cbi8vIFNldHMgc2VydmVyIHBvcnQgYW5kIGxvZ3MgbWVzc2FnZSBvbiBzdWNjZXNzXG5hcHAubGlzdGVuKDMwMDAsICgpID0+IGNvbnNvbGUubG9nKFwid2ViaG9vayBpcyBsaXN0ZW5pbmdcIikpO1xuXG4vLyBBZGRzIHN1cHBvcnQgZm9yIEdFVCByZXF1ZXN0cyB0byBvdXIgd2ViaG9va1xuYXBwLmdldChcIi93ZWJob29rXCIsIChyZXEsIHJlcykgPT4ge1xuICBsZXQgVkVSSUZZX1RPS0VOID0gcHJvY2Vzcy5lbnYuVkVSSUZZX1RPS0VOO1xuXG4gIC8vIFBhcnNlIHRoZSBxdWVyeSBwYXJhbXNcbiAgbGV0IG1vZGUgPSByZXEucXVlcnlbXCJodWIubW9kZVwiXTtcbiAgbGV0IHRva2VuID0gcmVxLnF1ZXJ5W1wiaHViLnZlcmlmeV90b2tlblwiXTtcbiAgbGV0IGNoYWxsZW5nZSA9IHJlcS5xdWVyeVtcImh1Yi5jaGFsbGVuZ2VcIl07XG5cbiAgLy8gQ2hlY2tzIGlmIGEgdG9rZW4gYW5kIG1vZGUgaXMgaW4gdGhlIHF1ZXJ5IHN0cmluZyBvZiB0aGUgcmVxdWVzdFxuICBpZiAobW9kZSAmJiB0b2tlbikge1xuICAgIC8vIENoZWNrcyB0aGUgbW9kZSBhbmQgdG9rZW4gc2VudCBpcyBjb3JyZWN0XG4gICAgaWYgKG1vZGUgPT09IFwic3Vic2NyaWJlXCIgJiYgdG9rZW4gPT09IFZFUklGWV9UT0tFTikge1xuICAgICAgLy8gUmVzcG9uZHMgd2l0aCB0aGUgY2hhbGxlbmdlIHRva2VuIGZyb20gdGhlIHJlcXVlc3RcbiAgICAgIGNvbnNvbGUubG9nKFwiV0VCSE9PS19WRVJJRklFRFwiKTtcbiAgICAgIHJlcy5zdGF0dXMoMjAwKS5zZW5kKGNoYWxsZW5nZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFJlc3BvbmRzIHdpdGggJzQwMyBGb3JiaWRkZW4nIGlmIHZlcmlmeSB0b2tlbnMgZG8gbm90IG1hdGNoXG4gICAgICByZXMuc2VuZFN0YXR1cyg0MDMpO1xuICAgIH1cbiAgfVxufSk7XG5cbi8vIENyZWF0ZXMgdGhlIGVuZHBvaW50IGZvciBvdXIgd2ViaG9va1xuYXBwLnBvc3QoXCIvd2ViaG9va1wiLCAocmVxLCByZXMpID0+IHtcbiAgbGV0IGJvZHkgPSByZXEuYm9keTtcblxuICAvLyBDaGVja3MgdGhpcyBpcyBhbiBldmVudCBmcm9tIGEgcGFnZSBzdWJzY3JpcHRpb25cbiAgaWYgKGJvZHkub2JqZWN0ID09PSBcInBhZ2VcIikge1xuICAgIC8vIEl0ZXJhdGVzIG92ZXIgZWFjaCBlbnRyeSAtIHRoZXJlIG1heSBiZSBtdWx0aXBsZSBpZiBiYXRjaGVkXG4gICAgYm9keS5lbnRyeS5mb3JFYWNoKGZ1bmN0aW9uKGVudHJ5KSB7XG4gICAgICAvLyBHZXRzIHRoZSBtZXNzYWdlLiBlbnRyeS5tZXNzYWdpbmcgaXMgYW4gYXJyYXksIGJ1dFxuICAgICAgLy8gd2lsbCBvbmx5IGV2ZXIgY29udGFpbiBvbmUgbWVzc2FnZSwgc28gd2UgZ2V0IGluZGV4IDBcbiAgICAgIGxldCB3ZWJob29rX2V2ZW50ID0gZW50cnkubWVzc2FnaW5nWzBdO1xuICAgICAgLy8gY29uc29sZS5sb2cod2ViaG9va19ldmVudCk7XG5cbiAgICAgIC8vIEdldCB0aGUgc2VuZGVyIFBTSURcbiAgICAgIGxldCBzZW5kZXJfcHNpZCA9IHdlYmhvb2tfZXZlbnQuc2VuZGVyLmlkO1xuICAgICAgLy8gY29uc29sZS5sb2coXCJTZW5kZXIgUFNJRDogXCIgKyBzZW5kZXJfcHNpZCk7XG5cbiAgICAgIC8vIENoZWNrIGlmIHRoZSBldmVudCBpcyBhIG1lc3NhZ2Ugb3IgcG9zdGJhY2sgYW5kXG4gICAgICAvLyBwYXNzIHRoZSBldmVudCB0byB0aGUgYXBwcm9wcmlhdGUgaGFuZGxlciBmdW5jdGlvblxuICAgICAgaWYgKHdlYmhvb2tfZXZlbnQubWVzc2FnZSkge1xuICAgICAgICAvLyBnZXROYW1lKHNlbmRlcl9wc2lkLCBmdW5jdGlvbihyZXNwb25zZSl7XG4gICAgICAgIC8vICAgICBjaGVja1VzZXIoc2VuZGVyX3BzaWQscmVzcG9uc2UpO1xuICAgICAgICAvLyB9KTtcbiAgICAgICAgaGFuZGxlTWVzc2FnZShzZW5kZXJfcHNpZCwgd2ViaG9va19ldmVudC5tZXNzYWdlKTtcbiAgICAgIH0gZWxzZSBpZiAod2ViaG9va19ldmVudC5wb3N0YmFjaykge1xuICAgICAgICBoYW5kbGVQb3N0YmFjayhzZW5kZXJfcHNpZCwgd2ViaG9va19ldmVudC5wb3N0YmFjayk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyBSZXR1cm5zIGEgJzIwMCBPSycgcmVzcG9uc2UgdG8gYWxsIHJlcXVlc3RzXG4gICAgcmVzLnN0YXR1cygyMDApLnNlbmQoXCJFVkVOVF9SRUNFSVZFRFwiKTtcbiAgfSBlbHNlIHtcbiAgICAvLyBSZXR1cm5zIGEgJzQwNCBOb3QgRm91bmQnIGlmIGV2ZW50IGlzIG5vdCBmcm9tIGEgcGFnZSBzdWJzY3JpcHRpb25cbiAgICByZXMuc2VuZFN0YXR1cyg0MDQpO1xuICB9XG59KTtcblxuLy8gR2V0cyB1c2VycyBuYW1lIGZyb20gZmFjZWJvb2sgZ3JhcGggYXBpXG4vLyBmdW5jdGlvbiBnZXROYW1lKHNlbmRlcl9wc2lkLGNhbGxiYWNrKXtcbi8vICAgICB2YXIgbmFtZSA9IFwiRW1wdHlcIjtcbi8vICAgICByZXF1ZXN0KHtcbi8vICAgICAgICAgdXJsOlwiaHR0cHM6Ly9ncmFwaC5mYWNlYm9vay5jb20vdjMuMy9cIiArIHNlbmRlcl9wc2lkLFxuLy8gICAgICAgICBxczp7XG4vLyAgICAgICAgICAgICBhY2Nlc3NfdG9rZW46IFBBR0VfQUNDRVNTX1RPS0VOLFxuLy8gICAgICAgICAgICAgZmllbGRzOiBcImZpcnN0X25hbWVcIixcbi8vICAgICAgICAgfSxcbi8vICAgICAgICAgbWV0aG9kOlwiR0VUXCJcbi8vICAgICB9LCBmdW5jdGlvbihlcnJvcixyZXNwb25zZSxib2R5KXtcbi8vICAgICAgICAgaWYgKGVycm9yKXtcbi8vICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycm9yKVxuLy8gICAgICAgICB9ZWxzZXtcbi8vICAgICAgICAgICAgIHZhciBib2R5T2JqID0gSlNPTi5wYXJzZShib2R5KTtcbi8vICAgICAgICAgICAgIG5hbWUgPSBib2R5T2JqLmZpcnN0X25hbWU7XG4vLyAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIk5hbWU6IFwiICsgbmFtZSk7XG4vLyAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sobmFtZSlcbi8vICAgICAgICAgfVxuLy8gICAgIH0pO1xuLy8gICAgIHJldHVybiBuYW1lO1xuLy8gfVxuXG4vLyBIYW5kbGVzIG1lc3NhZ2VzIGV2ZW50c1xuZnVuY3Rpb24gaGFuZGxlTWVzc2FnZShzZW5kZXJfcHNpZCwgcmVjZWl2ZWRfbWVzc2FnZSkge1xuICBsZXQgcmVzcG9uc2U7XG5cbiAgLy8gQ2hlY2sgaWYgdGhlIG1lc3NhZ2UgY29udGFpbnMgdGV4dFxuICBpZiAocmVjZWl2ZWRfbWVzc2FnZS50ZXh0KSB7XG4gICAgY29uc29sZS5sb2coYFJlY2VpdmVkIG1lc3NhZ2U6IFwiJHtyZWNlaXZlZF9tZXNzYWdlLnRleHR9XCJgKTtcblxuICAgIHJlc3BvbnNlID0gcHJvY2Vzc01lc3NhZ2Uoc2VuZGVyX3BzaWQsIHJlY2VpdmVkX21lc3NhZ2UpO1xuICAgIC8vIERlZmF1bHQgcmVzcG9uc2UgKGZvciBkZWJ1Z2dpbmcpXG4gICAgLy8gQ3JlYXRlIHRoZSBwYXlsb2FkIGZvciBhIGJhc2ljIHRleHQgbWVzc2FnZVxuICAgIC8vIHJlc3BvbnNlID0ge1xuICAgIC8vICAgdGV4dDogYFlvdSBzZW50IHRoZSBtZXNzYWdlOiBcIiR7cmVjZWl2ZWRfbWVzc2FnZS50ZXh0fVwiLmBcbiAgICAvLyB9O1xuICB9IGVsc2Uge1xuICAgIHJlc3BvbnNlID0gZGVmYXVsdFJlc3BvbnNlKCk7XG4gICAgLy8gICAgIC8vIEdldHMgdGhlIFVSTCBvZiB0aGUgbWVzc2FnZSBhdHRhY2htZW50XG4gICAgLy8gICAgIGxldCBhdHRhY2htZW50X3VybCA9IHJlY2VpdmVkX21lc3NhZ2UuYXR0YWNobWVudHNbMF0ucGF5bG9hZC51cmw7XG4gIH1cblxuICAvLyBTZW5kcyB0aGUgcmVzcG9uc2UgbWVzc2FnZVxuICBjYWxsU2VuZEFQSShzZW5kZXJfcHNpZCwgcmVzcG9uc2UpO1xufVxuXG5mdW5jdGlvbiBwcm9jZXNzTWVzc2FnZShzZW5kZXJfcHNpZCwgbWVzc2FnZSkge1xuICAvLyBOTFA6IGh0dHBzOi8vZGV2ZWxvcGVycy5mYWNlYm9vay5jb20vZG9jcy9tZXNzZW5nZXItcGxhdGZvcm0vYnVpbHQtaW4tbmxwXG4gIGxldCBlbnRpdGllcyA9IG1lc3NhZ2UubmxwW1wiZW50aXRpZXNcIl07XG5cbiAgLy8gT2JqZWN0LmtleXMoZW50aXRpZXMpLmZvckVhY2goa2V5ID0+IHtcbiAgLy8gICBjb25zb2xlLmxvZyhrZXkpO1xuICAvLyAgIGNvbnNvbGUubG9nKGVudGl0aWVzW2tleV0pO1xuICAvLyB9KTtcblxuICAvLyBDaGVjayBncmVldGluZ1xuICBsZXQgaXNfZ3JlZXRpbmcgPVxuICAgIGVudGl0aWVzW1wiZ3JlZXRpbmdzXCJdICE9IG51bGwgJiZcbiAgICBlbnRpdGllc1tcImdyZWV0aW5nc1wiXVswXVtcImNvbmZpZGVuY2VcIl0gPiAwLjg7IC8vIEdyZWV0aW5nIHRocmVzaG9sZCBzZXQgdG8gMC44XG5cbiAgLy8gUmV0cmlldmUgZmlyc3QgaW50ZW50IG9iamVjdFxuICBsZXQgaW50ZW50ID0gZW50aXRpZXNbXCJpbnRlbnRcIl1bMF07XG5cbiAgaWYgKGludGVudFtcImNvbmZpZGVuY2VcIl0gPiAwLjUpIHtcbiAgICAvLyBQcm9jZXNzIGludGVudFxuICAgIGxldCBpbnRlbnRfcGFydHMgPSBpbnRlbnRbXCJ2YWx1ZVwiXS5zcGxpdChcIl9cIik7XG4gICAgbGV0IGludGVudF9jYXRlZ29yeSA9IGludGVudF9wYXJ0c1swXTtcbiAgICBsZXQgcmVzcG9uc2UgPSBudWxsO1xuXG4gICAgaWYgKGludGVudF9jYXRlZ29yeSA9PT0gXCJyZWNvbW1lbmRhdGlvblwiKSB7XG4gICAgICAvLyBIYW5kbGUgcmVjb21tZW5kYXRpb25cbiAgICAgIC8vIHJlc3BvbnNlID0gZ2VuZXJhdGVSZXNwb25zZUZyb21NZXNzYWdlKFxuICAgICAgLy8gICBcIk1lc3NhZ2UgcmVjZWl2ZWQgaXMgYSByZWNvbW1lbmRhdGlvbiBtZXNzYWdlLlwiXG4gICAgICAvLyApO1xuXG4gICAgICBsZXQgcHJvZHVjdF90eXBlcyA9IFtdO1xuICAgICAgaWYgKGVudGl0aWVzW1wicHJvZHVjdF90eXBlXCJdKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiUHJvY2Vzc2luZyBwcm9kdWN0IHR5cGVzXCIpO1xuICAgICAgICBwcm9kdWN0X3R5cGVzID0gZW50aXRpZXNbXCJwcm9kdWN0X3R5cGVcIl1cbiAgICAgICAgICAuZmlsdGVyKG9iaiA9PiBvYmpbXCJjb25maWRlbmNlXCJdID4gMC41KVxuICAgICAgICAgIC5tYXAob2JqID0+IG9ialtcInZhbHVlXCJdKTtcbiAgICAgIH1cblxuICAgICAgcmVzcG9uc2UgPSBnZW5lcmF0ZVJlY29tbWVuZGF0aW9uc1Jlc3BvbnNlKHByb2R1Y3RfdHlwZXMpO1xuICAgIH1cblxuICAgIGlmIChpbnRlbnRfY2F0ZWdvcnkgPT09IFwiZW5xdWlyeVwiKSB7XG4gICAgICAvLyBIYW5kbGUgZW5xdWlyeVxuICAgICAgLy8gcmVzcG9uc2UgPSBnZW5lcmF0ZVJlc3BvbnNlRnJvbU1lc3NhZ2UoXG4gICAgICAvLyAgIFwiTWVzc2FnZSByZWNlaXZlZCBpcyBhbiBlbnF1aXJ5IG1lc3NhZ2UuXCJcbiAgICAgIC8vICk7XG5cbiAgICAgIGxldCBpbnRlbnRfc3ViY2F0ZWdvcnkgPSBpbnRlbnRfcGFydHNbMV07XG5cbiAgICAgIGlmIChpbnRlbnRfc3ViY2F0ZWdvcnkgPT09IFwiZ2VuZXJhbFwiKSB7XG4gICAgICAgIGlmIChlbnRpdGllc1tcInByb2ZpdFwiXSkge1xuICAgICAgICAgIHJlc3BvbnNlID0gZ2VuZXJhdGVSZXNwb25zZUZyb21NZXNzYWdlKFxuICAgICAgICAgICAgXCJBbGwgbmV0IHJldmVudWUgZWFybmVkIGZyb20gdGhlIHNhbGUgb2Ygb3VyIHByb2R1Y3RzIGFuZCBzZXJ2aWNlcyBnbyB0b3dhcmRzIHBheWluZyBhIG1vbnRobHkgYWxsb3dhbmNlIGZvciBvdXIgY2xpZW50cycgd29yaywgYXMgd2VsbCBhcyB0aGVpciBsdW5jaCBleHBlbnNlcyB3aGlsZSB1bmRlcmdvaW5nIHRyYWluaW5nLlwiXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIGlmIChlbnRpdGllc1tcIm1hbnVmYWN0dXJlclwiXSkge1xuICAgICAgICAgIHJlc3BvbnNlID0gZ2VuZXJhdGVSZXNwb25zZUZyb21NZXNzYWdlKFxuICAgICAgICAgICAgXCJXZSBzdXBwb3J0IGFkdWx0cyB3aXRoIGludGVsbGVjdHVhbCBkaXNhYmlsaXRpZXMuIFdlIHN0YXJ0ZWQgYSByYW5nZSBvZiBzb2NpYWwgZW50ZXJwcmlzZSBwcm9qZWN0cyB0byBwcm92aWRlIGFsdGVybmF0aXZlIHdvcmsgZW5nYWdlbWVudCBmb3Igb3VyIGFkdWx0IHRyYWluZWVzLlwiXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIGlmIChlbnRpdGllc1tcInByb2R1Y3RzXCJdKSB7XG4gICAgICAgICAgcmVzcG9uc2UgPSBnZW5lcmF0ZVJlc3BvbnNlRnJvbU1lc3NhZ2UoXCJXZSBzZWxsIGNyYWZ0IGFuZCBiYWtlciBnb29kcy5cIik7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoaW50ZW50X3N1YmNhdGVnb3J5ID09PSBcImRlbGl2ZXJ5XCIpIHtcbiAgICAgICAgLy8gQ2hlY2sgZm9yIGVzdGltYXRlZCBhcnJpdmFsIGVudGl0eVxuICAgICAgICBpZiAoZW50aXRpZXNbXCJlc3RpbWF0ZWRfYXJyaXZhbFwiXSkge1xuICAgICAgICAgIHJlc3BvbnNlID0gZ2VuZXJhdGVSZXNwb25zZUZyb21NZXNzYWdlKFxuICAgICAgICAgICAgXCJUaGUgYXZlcmFnZSBkZWxpdmVyeSB0aW1lIHRha2VzIDUtNyB3b3JraW5nIGRheXMuIFlvdXIgb3JkZXJlZCB3YXMgc2VudCBvbiAxNyBGZWJydWFyeS4gSXQgaXMgZXN0aW1hdGVkIHRvIGFycml2ZSBvbiB7c2VudCBkYXRlICsgNyB3b3JraW5nIGRheX0uXCJcbiAgICAgICAgICApO1xuICAgICAgICB9IGVsc2UgaWYgKGVudGl0aWVzW1wiY29zdFwiXSkge1xuICAgICAgICAgIHJlc3BvbnNlID0gZ2VuZXJhdGVSZXNwb25zZUZyb21NZXNzYWdlKFwiSXQgaXMgYSBmbGF0IGZlZSBvZiAkMiBmb3IgZXZlcnkgb3JkZXIuXCIpO1xuICAgICAgICB9IGVsc2UgaWYgKGVudGl0aWVzW1wic3RhdHVzXCJdKSB7XG4gICAgICAgICAgLy8gVE9ETzogT3JkZXIgc3RhdHVzXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzcG9uc2UgPSBnZW5lcmF0ZVJlc3BvbnNlRnJvbU1lc3NhZ2UoXG4gICAgICAgICAgICBcIldlIGRlbGl2ZXIgaXNsYW5kd2lkZS4gVGhlIGF2ZXJhZ2UgZGVsaXZlcnkgdGltZSB0YWtlcyA1LTcgd29ya2luZyBkYXlzLlwiXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChpbnRlbnRfY2F0ZWdvcnkgPT09IFwiY2FydFwiKSB7XG4gICAgICAvLyBIYW5kbGUgc2hvcHBpbmcgY2FydFxuICAgICAgcmVzcG9uc2UgPSBnZW5lcmF0ZVJlc3BvbnNlRnJvbU1lc3NhZ2UoXG4gICAgICAgIFwiTWVzc2FnZSByZWNlaXZlZCBpcyBhIGNhcnQgbWVzc2FnZS5cIlxuICAgICAgKTtcblxuICAgICAgbGV0IGludGVudF9zdWJjYXRlZ29yeSA9IGludGVudF9wYXJ0c1sxXTtcbiAgICAgIGlmIChpbnRlbnRfc3ViY2F0ZWdvcnkgPT09IFwiYWRkXCIgJiYgZW50aXRpZXNbXCJwcm9kdWN0XCJdKSB7XG4gICAgICAgIGxldCBwcm9kdWN0X25hbWUgPSBlbnRpdGllc1tcInByb2R1Y3RcIl1bMF1bXCJ2YWx1ZVwiXTtcbiAgICAgICAgbGV0IHF1YW50aXR5ID0gZW50aXRpZXNbXCJudW1iZXJcIl0gPyBlbnRpdGllc1tcIm51bWJlclwiXVswXVtcInZhbHVlXCJdIDogMTtcbiAgICAgICAgcmVzcG9uc2UgPSBnZW5lcmF0ZUFkZENhcnRSZXNwb25zZShzZW5kZXJfcHNpZCwgcHJvZHVjdF9uYW1lLCBxdWFudGl0eSk7XG4gICAgICB9IGVsc2UgaWYgKGludGVudF9zdWJjYXRlZ29yeSA9PT0gXCJ2aWV3XCIpIHtcbiAgICAgICAgcmVzcG9uc2UgPSBnZW5lcmF0ZVZpZXdDYXJ0UmVzcG9uc2Uoc2VuZGVyX3BzaWQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChyZXNwb25zZSA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGRlZmF1bHRSZXNwb25zZSgpO1xuICAgIH1cblxuICAgIHJldHVybiByZXNwb25zZTtcbiAgfSBlbHNlIGlmIChpc19ncmVldGluZykge1xuICAgIC8vIE1lc3NhZ2UgaGFzIG5vIGludGVudCwganVzdCBncmVldGluZ1xuICAgIHJldHVybiBnZW5lcmF0ZVJlc3BvbnNlRnJvbU1lc3NhZ2UoXG4gICAgICBcIkhpIHRoZXJlISBXZWxjb21lIHRvIE1JTkRTLiBIb3cgY2FuIEkgaGVscCB5b3U/XCJcbiAgICApO1xuICB9XG5cbiAgT2JqZWN0LmtleXMoZW50aXRpZXMpLmZvckVhY2goa2V5ID0+IHtcbiAgICBjb25zb2xlLmxvZyhrZXkpO1xuICAgIGNvbnNvbGUubG9nKGVudGl0aWVzW2tleV0pO1xuICB9KTtcblxuICByZXR1cm4gZGVmYXVsdFJlc3BvbnNlKCk7XG59XG5cbmZ1bmN0aW9uIGRlZmF1bHRSZXNwb25zZSgpIHtcbiAgcmV0dXJuIGdlbmVyYXRlUmVzcG9uc2VGcm9tTWVzc2FnZShcbiAgICBcIldlIGNvdWxkIG5vdCB1bmRlcnN0YW5kIHlvdXIgbWVzc2FnZS4gS2luZGx5IHJlcGhyYXNlIHlvdXIgbWVzc2FnZSBhbmQgc2VuZCB1cyBhZ2Fpbi5cIlxuICApO1xufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZVJlc3BvbnNlRnJvbU1lc3NhZ2UobWVzc2FnZSkge1xuICByZXR1cm4ge1xuICAgIHRleHQ6IG1lc3NhZ2VcbiAgfTtcbn1cblxuZnVuY3Rpb24gZ2VuZXJhdGVSZWNvbW1lbmRhdGlvbnNUZW1wbGF0ZUVsZW1lbnRzKHByb2R1Y3RzKSB7XG4gIGxldCB0ZW1wbGF0ZV9lbGVtZW50cyA9IHByb2R1Y3RzLm1hcChwcm9kdWN0ID0+IHtcbiAgICByZXR1cm4ge1xuICAgICAgdGl0bGU6IHByb2R1Y3RbXCJuYW1lXCJdLFxuICAgICAgc3VidGl0bGU6IGAkJHtwcm9kdWN0W1wicHJpY2VcIl19YCxcbiAgICAgIGltYWdlX3VybDogcHJvZHVjdFtcInVybFwiXSxcbiAgICAgIGJ1dHRvbnM6IFtcbiAgICAgICAge1xuICAgICAgICAgIHR5cGU6IFwicG9zdGJhY2tcIixcbiAgICAgICAgICB0aXRsZTogXCJMZWFybiBNb3JlXCIsXG4gICAgICAgICAgcGF5bG9hZDogYGVucXVpcnlfcHJvZHVjdCAke3Byb2R1Y3RbXCJuYW1lXCJdfWBcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHR5cGU6IFwicG9zdGJhY2tcIixcbiAgICAgICAgICB0aXRsZTogXCJBZGQgdG8gQ2FydFwiLFxuICAgICAgICAgIHBheWxvYWQ6IGBjYXJ0X2FkZCAke3Byb2R1Y3RbXCJuYW1lXCJdfWBcbiAgICAgICAgfVxuICAgICAgXVxuICAgIH07XG4gIH0pO1xuICByZXR1cm4gdGVtcGxhdGVfZWxlbWVudHM7XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlUmVjb21tZW5kYXRpb25zUmVzcG9uc2UocHJvZHVjdF90eXBlcykge1xuICBsZXQgcmVzcG9uc2UgPSB7XG4gICAgYXR0YWNobWVudDoge1xuICAgICAgdHlwZTogXCJ0ZW1wbGF0ZVwiLFxuICAgICAgcGF5bG9hZDoge1xuICAgICAgICB0ZW1wbGF0ZV90eXBlOiBcImdlbmVyaWNcIixcbiAgICAgICAgZWxlbWVudHM6IGdlbmVyYXRlUmVjb21tZW5kYXRpb25zVGVtcGxhdGVFbGVtZW50cyhbXG4gICAgICAgICAge1xuICAgICAgICAgICAgaWQ6IDEsXG4gICAgICAgICAgICBuYW1lOiBcIkRhcmsgQ2hvY29sYXRlIE9hdG1lYWwgQ29va2llc1wiLFxuICAgICAgICAgICAgcHJpY2U6IDMuNSxcbiAgICAgICAgICAgIHVybDpcbiAgICAgICAgICAgICAgXCJodHRwczovL3N0YXRpYy53aXhzdGF0aWMuY29tL21lZGlhLzc2ODk3OV8zZmNjYjJiYjgzN2E0NGNhYTgwYmI0ZmM1ZGRkZDExOX5tdjJfZF8xODAwXzE4MDBfc18yLmpwZ1wiLFxuICAgICAgICAgICAgYXR0cmlidXRlOiB7XG4gICAgICAgICAgICAgIGFsbGVnZW5zOiBbJ2VnZ3MnLCAnbnV0J10sXG4gICAgICAgICAgICAgIGNvbG91cjogbnVsbCxcbiAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBpZDogMixcbiAgICAgICAgICAgIG5hbWU6IFwiQ3JhbmJlcnJ5IFN3ZWV0aGVhcnQgQ29va2llcyAoRWdnbGVzcylcIixcbiAgICAgICAgICAgIHByaWNlOiAzLjUsXG4gICAgICAgICAgICB1cmw6XG4gICAgICAgICAgICAgIFwiaHR0cHM6Ly9zdGF0aWMud2l4c3RhdGljLmNvbS9tZWRpYS83Njg5NzlfM2ZjY2IyYmI4MzdhNDRjYWE4MGJiNGZjNWRkZGQxMTl+bXYyX2RfMTgwMF8xODAwX3NfMi5qcGdcIlxuICAgICAgICAgIH0sXG4gICAgICAgICAge1xuICAgICAgICAgICAgaWQ6IDMsXG4gICAgICAgICAgICBuYW1lOiBcIkVhcmwgR3JleSBTdW5mbG93ZXIgU2VlZHMgQ29va2llc1wiLFxuICAgICAgICAgICAgcHJpY2U6IDMuNSxcbiAgICAgICAgICAgIHVybDpcbiAgICAgICAgICAgICAgXCJodHRwczovL3N0YXRpYy53aXhzdGF0aWMuY29tL21lZGlhLzc2ODk3OV8zZmNjYjJiYjgzN2E0NGNhYTgwYmI0ZmM1ZGRkZDExOX5tdjJfZF8xODAwXzE4MDBfc18yLmpwZ1wiXG4gICAgICAgICAgfVxuICAgICAgICBdKVxuICAgICAgfVxuICAgIH1cbiAgfTtcbiAgcmV0dXJuIHJlc3BvbnNlO1xufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZUFkZENhcnRSZXNwb25zZShzZW5kZXJfcHNpZCwgcHJvZHVjdF9uYW1lLCBxdWFudGl0eSkge1xuICAvLyBUT0RPOiBBZGQgcHJvZHVjdCB0byBjYXJ0IGluIGRiXG5cbiAgcmV0dXJuIHtcbiAgICB0ZXh0OiBgQWRkZWQgJHtxdWFudGl0eX0gJHtwcm9kdWN0X25hbWV9IHRvIGNhcnQuYCxcbiAgICBxdWlja19yZXBsaWVzOiBbXG4gICAgICB7XG4gICAgICAgIFwiY29udGVudF90eXBlXCI6IFwidGV4dFwiLFxuICAgICAgICBcInRpdGxlXCI6IFwiVmlldyBDYXJ0XCIsXG4gICAgICAgIFwicGF5bG9hZFwiOiBgY2FydF92aWV3YFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgXCJjb250ZW50X3R5cGVcIjogXCJ0ZXh0XCIsXG4gICAgICAgIFwidGl0bGVcIjogXCJDaGVja291dFwiLFxuICAgICAgICBcInBheWxvYWRcIjogYGNoZWNrb3V0YFxuICAgICAgfVxuICAgIF1cbiAgfTtcbn1cblxuZnVuY3Rpb24gZ2VuZXJhdGVDYXJ0VGVtcGxhdGVFbGVtZW50cyhwcm9kdWN0cykge1xuICBsZXQgdGVtcGxhdGVfZWxlbWVudHMgPSBwcm9kdWN0cy5tYXAocHJvZHVjdCA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRpdGxlOiBwcm9kdWN0W1wibmFtZVwiXSxcbiAgICAgIHN1YnRpdGxlOiBgUXR5OiAke3Byb2R1Y3RbXCJxdWFudGl0eVwiXX0gKCQke3Byb2R1Y3RbXCJwcmljZVwiXX0gZWFjaClgLFxuICAgICAgaW1hZ2VfdXJsOiBwcm9kdWN0W1widXJsXCJdLFxuICAgICAgYnV0dG9uczogW1xuICAgICAgICB7XG4gICAgICAgICAgdHlwZTogXCJwb3N0YmFja1wiLFxuICAgICAgICAgIHRpdGxlOiBcIkFkZCAxXCIsXG4gICAgICAgICAgcGF5bG9hZDogYGNhcnRfYWRkICR7cHJvZHVjdFtcIm5hbWVcIl19YFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgdHlwZTogXCJwb3N0YmFja1wiLFxuICAgICAgICAgIHRpdGxlOiBcIlJlbW92ZSBBbGxcIixcbiAgICAgICAgICBwYXlsb2FkOiBgY2FydF9yZW1vdmUgJHtwcm9kdWN0W1wibmFtZVwiXX1gXG4gICAgICAgIH1cbiAgICAgIF1cbiAgICB9O1xuICB9KTtcbiAgcmV0dXJuIHRlbXBsYXRlX2VsZW1lbnRzO1xufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZVZpZXdDYXJ0UmVzcG9uc2UocHJvZHVjdF90eXBlcykge1xuICBsZXQgcmVzcG9uc2UgPSB7XG4gICAgYXR0YWNobWVudDoge1xuICAgICAgdHlwZTogXCJ0ZW1wbGF0ZVwiLFxuICAgICAgcGF5bG9hZDoge1xuICAgICAgICB0ZW1wbGF0ZV90eXBlOiBcImdlbmVyaWNcIixcbiAgICAgICAgZWxlbWVudHM6IGdlbmVyYXRlQ2FydFRlbXBsYXRlRWxlbWVudHMoW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIGlkOiAxLFxuICAgICAgICAgICAgbmFtZTogXCJEYXJrIENob2NvbGF0ZSBPYXRtZWFsIENvb2tpZXNcIixcbiAgICAgICAgICAgIHByaWNlOiAzLjUsXG4gICAgICAgICAgICB1cmw6XG4gICAgICAgICAgICAgIFwiaHR0cHM6Ly9zdGF0aWMud2l4c3RhdGljLmNvbS9tZWRpYS83Njg5NzlfM2ZjY2IyYmI4MzdhNDRjYWE4MGJiNGZjNWRkZGQxMTl+bXYyX2RfMTgwMF8xODAwX3NfMi5qcGdcIixcbiAgICAgICAgICAgIHF1YW50aXR5OiAxXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBpZDogMixcbiAgICAgICAgICAgIG5hbWU6IFwiQ3JhbmJlcnJ5IFN3ZWV0aGVhcnQgQ29va2llcyAoRWdnbGVzcylcIixcbiAgICAgICAgICAgIHByaWNlOiAzLjUsXG4gICAgICAgICAgICB1cmw6XG4gICAgICAgICAgICAgIFwiaHR0cHM6Ly9zdGF0aWMud2l4c3RhdGljLmNvbS9tZWRpYS83Njg5NzlfM2ZjY2IyYmI4MzdhNDRjYWE4MGJiNGZjNWRkZGQxMTl+bXYyX2RfMTgwMF8xODAwX3NfMi5qcGdcIixcbiAgICAgICAgICAgIHF1YW50aXR5OiAyXG4gICAgICAgICAgfSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBpZDogMyxcbiAgICAgICAgICAgIG5hbWU6IFwiRWFybCBHcmV5IFN1bmZsb3dlciBTZWVkcyBDb29raWVzXCIsXG4gICAgICAgICAgICBwcmljZTogMy41LFxuICAgICAgICAgICAgdXJsOlxuICAgICAgICAgICAgICBcImh0dHBzOi8vc3RhdGljLndpeHN0YXRpYy5jb20vbWVkaWEvNzY4OTc5XzNmY2NiMmJiODM3YTQ0Y2FhODBiYjRmYzVkZGRkMTE5fm12Ml9kXzE4MDBfMTgwMF9zXzIuanBnXCIsXG4gICAgICAgICAgICBxdWFudGl0eTogMVxuICAgICAgICAgIH1cbiAgICAgICAgXSlcbiAgICAgIH1cbiAgICB9XG4gIH07XG4gIHJldHVybiByZXNwb25zZTtcbn1cblxuLy8gSGFuZGxlcyBtZXNzYWdpbmdfcG9zdGJhY2tzIGV2ZW50c1xuZnVuY3Rpb24gaGFuZGxlUG9zdGJhY2soc2VuZGVyX3BzaWQsIHJlY2VpdmVkX3Bvc3RiYWNrKSB7XG4gIGxldCByZXNwb25zZTtcblxuICAvLyBHZXQgdGhlIHBheWxvYWQgZm9yIHRoZSBwb3N0YmFja1xuICBsZXQgcGF5bG9hZCA9IHJlY2VpdmVkX3Bvc3RiYWNrLnBheWxvYWQ7XG4gIGNvbnNvbGUubG9nKGBSZWNlaXZlZCBwb3N0YmFjazogXCIke3BheWxvYWR9XCJgKTtcblxuICBsZXQgcG9zdGJhY2tfaW50ZW50ID0gcGF5bG9hZC5zcGxpdChcIiBcIilbMF07XG4gIGxldCBwb3N0YmFja19jb250ZW50ID0gcGF5bG9hZC5zdWJzdHJpbmcoXG4gICAgcGF5bG9hZC5pbmRleE9mKFwiIFwiKSArIDEsXG4gICAgcGF5bG9hZC5sZW5ndGhcbiAgKTtcblxuICAvLyBTZXQgdGhlIHJlc3BvbnNlIGJhc2VkIG9uIHRoZSBwb3N0YmFjayBpbnRlbnRcbiAgaWYgKHBvc3RiYWNrX2ludGVudCA9PT0gXCJjYXJ0X2FkZFwiKSB7XG4gICAgLy8gQWRkIHRvIGNhcnRcbiAgICByZXNwb25zZSA9IGdlbmVyYXRlQWRkQ2FydFJlc3BvbnNlKHNlbmRlcl9wc2lkLCBwb3N0YmFja19jb250ZW50LCAxKTtcbiAgfSBlbHNlIGlmIChwb3N0YmFja19pbnRlbnQgPT09IFwiY2FydF92aWV3XCIpIHtcbiAgICByZXNwb25zZSA9IGdlbmVyYXRlVmlld0NhcnRSZXNwb25zZShzZW5kZXJfcHNpZCk7XG4gIH0gZWxzZSBpZiAocG9zdGJhY2tfaW50ZW50ID09PSBcImVucXVpcnlfcHJvZHVjdFwiKSB7XG4gICAgcmVzcG9uc2UgPSB7XG4gICAgICB0ZXh0OiBgV2hhdCB3b3VsZCB5b3UgbGlrZSB0byBrbm93IGFib3V0IG91ciAke3Bvc3RiYWNrX2NvbnRlbnR9P2BcbiAgICB9O1xuICB9XG5cbiAgaWYgKHJlc3BvbnNlID09IG51bGwpIHtcbiAgICByZXNwb25zZSA9IGRlZmF1bHRSZXNwb25zZSgpO1xuICB9XG5cbiAgLy8gU2VuZCB0aGUgbWVzc2FnZSB0byBhY2tub3dsZWRnZSB0aGUgcG9zdGJhY2tcbiAgY2FsbFNlbmRBUEkoc2VuZGVyX3BzaWQsIHJlc3BvbnNlKTtcbn1cblxuLy8gU2VuZHMgcmVzcG9uc2UgbWVzc2FnZXMgdmlhIHRoZSBTZW5kIEFQSVxuZnVuY3Rpb24gY2FsbFNlbmRBUEkoc2VuZGVyX3BzaWQsIHJlc3BvbnNlKSB7XG4gIC8vIENvbnN0cnVjdCB0aGUgbWVzc2FnZSBib2R5XG4gIGxldCByZXF1ZXN0X2JvZHkgPSB7XG4gICAgcmVjaXBpZW50OiB7XG4gICAgICBpZDogc2VuZGVyX3BzaWRcbiAgICB9LFxuICAgIG1lc3NhZ2U6IHJlc3BvbnNlXG4gIH07XG5cbiAgLy8gU2VuZCB0aGUgSFRUUCByZXF1ZXN0IHRvIHRoZSBNZXNzZW5nZXIgUGxhdGZvcm1cbiAgcmVxdWVzdChcbiAgICB7XG4gICAgICB1cmk6IFwiaHR0cHM6Ly9ncmFwaC5mYWNlYm9vay5jb20vdjIuNi9tZS9tZXNzYWdlc1wiLFxuICAgICAgcXM6IHsgYWNjZXNzX3Rva2VuOiBQQUdFX0FDQ0VTU19UT0tFTiB9LFxuICAgICAgbWV0aG9kOiBcIlBPU1RcIixcbiAgICAgIGpzb246IHJlcXVlc3RfYm9keVxuICAgIH0sXG4gICAgKGVyciwgcmVzLCBib2R5KSA9PiB7XG4gICAgICBpZiAoIWVycikge1xuICAgICAgICBjb25zb2xlLmxvZyhcIk1lc3NhZ2Ugc2VudCFcIik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiVW5hYmxlIHRvIHNlbmQgbWVzc2FnZTpcIiArIGVycik7XG4gICAgICB9XG4gICAgfVxuICApO1xufVxuIl19",
    "ast": null,
    "map": {
      "version": 3,
      "sources": [
        "index.js"
      ],
      "names": [
        "express",
        "require",
        "bodyParser",
        "app",
        "use",
        "json",
        "request",
        "PAGE_ACCESS_TOKEN",
        "process",
        "env",
        "listen",
        "console",
        "log",
        "get",
        "req",
        "res",
        "VERIFY_TOKEN",
        "mode",
        "query",
        "token",
        "challenge",
        "status",
        "send",
        "sendStatus",
        "post",
        "body",
        "object",
        "entry",
        "forEach",
        "webhook_event",
        "messaging",
        "sender_psid",
        "sender",
        "id",
        "message",
        "handleMessage",
        "postback",
        "handlePostback",
        "received_message",
        "response",
        "text",
        "processMessage",
        "defaultResponse",
        "callSendAPI",
        "entities",
        "nlp",
        "is_greeting",
        "intent",
        "intent_parts",
        "split",
        "intent_category",
        "product_types",
        "filter",
        "obj",
        "map",
        "generateRecommendationsResponse",
        "intent_subcategory",
        "generateResponseFromMessage",
        "product_name",
        "quantity",
        "generateAddCartResponse",
        "generateViewCartResponse",
        "Object",
        "keys",
        "key",
        "generateRecommendationsTemplateElements",
        "products",
        "template_elements",
        "title",
        "product",
        "subtitle",
        "image_url",
        "buttons",
        "type",
        "payload",
        "attachment",
        "template_type",
        "elements",
        "name",
        "price",
        "url",
        "attribute",
        "allegens",
        "colour",
        "quick_replies",
        "generateCartTemplateElements",
        "received_postback",
        "postback_intent",
        "postback_content",
        "substring",
        "indexOf",
        "length",
        "request_body",
        "recipient",
        "uri",
        "qs",
        "access_token",
        "method",
        "err",
        "error"
      ],
      "mappings": "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",
      "file": "index.js",
      "sourceRoot": "/app",
      "sourcesContent": [
        "// https://developers.facebook.com/docs/messenger-platform/getting-started/webhook-setup/\n// https://developers.facebook.com/docs/messenger-platform/getting-started/app-setup\n// https://developers.facebook.com/docs/messenger-platform/getting-started/quick-start\n\n\"use strict\";\n\n// Imports dependencies and set up http server\nconst express = require(\"express\"),\n  bodyParser = require(\"body-parser\"),\n  app = express().use(bodyParser.json()); // creates express http server\nconst request = require(\"request\");\n\n// import { checkUser, createUser } from './DBConn';\n\n// Get page access token\nconst PAGE_ACCESS_TOKEN = process.env.PAGE_ACCESS_TOKEN;\n\n// Sets server port and logs message on success\napp.listen(3000, () => console.log(\"webhook is listening\"));\n\n// Adds support for GET requests to our webhook\napp.get(\"/webhook\", (req, res) => {\n  let VERIFY_TOKEN = process.env.VERIFY_TOKEN;\n\n  // Parse the query params\n  let mode = req.query[\"hub.mode\"];\n  let token = req.query[\"hub.verify_token\"];\n  let challenge = req.query[\"hub.challenge\"];\n\n  // Checks if a token and mode is in the query string of the request\n  if (mode && token) {\n    // Checks the mode and token sent is correct\n    if (mode === \"subscribe\" && token === VERIFY_TOKEN) {\n      // Responds with the challenge token from the request\n      console.log(\"WEBHOOK_VERIFIED\");\n      res.status(200).send(challenge);\n    } else {\n      // Responds with '403 Forbidden' if verify tokens do not match\n      res.sendStatus(403);\n    }\n  }\n});\n\n// Creates the endpoint for our webhook\napp.post(\"/webhook\", (req, res) => {\n  let body = req.body;\n\n  // Checks this is an event from a page subscription\n  if (body.object === \"page\") {\n    // Iterates over each entry - there may be multiple if batched\n    body.entry.forEach(function(entry) {\n      // Gets the message. entry.messaging is an array, but\n      // will only ever contain one message, so we get index 0\n      let webhook_event = entry.messaging[0];\n      // console.log(webhook_event);\n\n      // Get the sender PSID\n      let sender_psid = webhook_event.sender.id;\n      // console.log(\"Sender PSID: \" + sender_psid);\n\n      // Check if the event is a message or postback and\n      // pass the event to the appropriate handler function\n      if (webhook_event.message) {\n        // getName(sender_psid, function(response){\n        //     checkUser(sender_psid,response);\n        // });\n        handleMessage(sender_psid, webhook_event.message);\n      } else if (webhook_event.postback) {\n        handlePostback(sender_psid, webhook_event.postback);\n      }\n    });\n\n    // Returns a '200 OK' response to all requests\n    res.status(200).send(\"EVENT_RECEIVED\");\n  } else {\n    // Returns a '404 Not Found' if event is not from a page subscription\n    res.sendStatus(404);\n  }\n});\n\n// Gets users name from facebook graph api\n// function getName(sender_psid,callback){\n//     var name = \"Empty\";\n//     request({\n//         url:\"https://graph.facebook.com/v3.3/\" + sender_psid,\n//         qs:{\n//             access_token: PAGE_ACCESS_TOKEN,\n//             fields: \"first_name\",\n//         },\n//         method:\"GET\"\n//     }, function(error,response,body){\n//         if (error){\n//             console.log(error)\n//         }else{\n//             var bodyObj = JSON.parse(body);\n//             name = bodyObj.first_name;\n//             console.log(\"Name: \" + name);\n//             return callback(name)\n//         }\n//     });\n//     return name;\n// }\n\n// Handles messages events\nfunction handleMessage(sender_psid, received_message) {\n  let response;\n\n  // Check if the message contains text\n  if (received_message.text) {\n    console.log(`Received message: \"${received_message.text}\"`);\n\n    response = processMessage(sender_psid, received_message);\n    // Default response (for debugging)\n    // Create the payload for a basic text message\n    // response = {\n    //   text: `You sent the message: \"${received_message.text}\".`\n    // };\n  } else {\n    response = defaultResponse();\n    //     // Gets the URL of the message attachment\n    //     let attachment_url = received_message.attachments[0].payload.url;\n  }\n\n  // Sends the response message\n  callSendAPI(sender_psid, response);\n}\n\nfunction processMessage(sender_psid, message) {\n  // NLP: https://developers.facebook.com/docs/messenger-platform/built-in-nlp\n  let entities = message.nlp[\"entities\"];\n\n  // Object.keys(entities).forEach(key => {\n  //   console.log(key);\n  //   console.log(entities[key]);\n  // });\n\n  // Check greeting\n  let is_greeting =\n    entities[\"greetings\"] != null &&\n    entities[\"greetings\"][0][\"confidence\"] > 0.8; // Greeting threshold set to 0.8\n\n  // Retrieve first intent object\n  let intent = entities[\"intent\"][0];\n\n  if (intent[\"confidence\"] > 0.5) {\n    // Process intent\n    let intent_parts = intent[\"value\"].split(\"_\");\n    let intent_category = intent_parts[0];\n    let response = null;\n\n    if (intent_category === \"recommendation\") {\n      // Handle recommendation\n      // response = generateResponseFromMessage(\n      //   \"Message received is a recommendation message.\"\n      // );\n\n      let product_types = [];\n      if (entities[\"product_type\"]) {\n        console.log(\"Processing product types\");\n        product_types = entities[\"product_type\"]\n          .filter(obj => obj[\"confidence\"] > 0.5)\n          .map(obj => obj[\"value\"]);\n      }\n\n      response = generateRecommendationsResponse(product_types);\n    }\n\n    if (intent_category === \"enquiry\") {\n      // Handle enquiry\n      // response = generateResponseFromMessage(\n      //   \"Message received is an enquiry message.\"\n      // );\n\n      let intent_subcategory = intent_parts[1];\n\n      if (intent_subcategory === \"general\") {\n        if (entities[\"profit\"]) {\n          response = generateResponseFromMessage(\n            \"All net revenue earned from the sale of our products and services go towards paying a monthly allowance for our clients' work, as well as their lunch expenses while undergoing training.\"\n          );\n        } else if (entities[\"manufacturer\"]) {\n          response = generateResponseFromMessage(\n            \"We support adults with intellectual disabilities. We started a range of social enterprise projects to provide alternative work engagement for our adult trainees.\"\n          );\n        } else if (entities[\"products\"]) {\n          response = generateResponseFromMessage(\"We sell craft and baker goods.\");\n        }\n      } else if (intent_subcategory === \"delivery\") {\n        // Check for estimated arrival entity\n        if (entities[\"estimated_arrival\"]) {\n          response = generateResponseFromMessage(\n            \"The average delivery time takes 5-7 working days. Your ordered was sent on 17 February. It is estimated to arrive on {sent date + 7 working day}.\"\n          );\n        } else if (entities[\"cost\"]) {\n          response = generateResponseFromMessage(\"It is a flat fee of $2 for every order.\");\n        } else if (entities[\"status\"]) {\n          // TODO: Order status\n        } else {\n          response = generateResponseFromMessage(\n            \"We deliver islandwide. The average delivery time takes 5-7 working days.\"\n          );\n        }\n      }\n    }\n\n    if (intent_category === \"cart\") {\n      // Handle shopping cart\n      response = generateResponseFromMessage(\n        \"Message received is a cart message.\"\n      );\n\n      let intent_subcategory = intent_parts[1];\n      if (intent_subcategory === \"add\" && entities[\"product\"]) {\n        let product_name = entities[\"product\"][0][\"value\"];\n        let quantity = entities[\"number\"] ? entities[\"number\"][0][\"value\"] : 1;\n        response = generateAddCartResponse(sender_psid, product_name, quantity);\n      } else if (intent_subcategory === \"view\") {\n        response = generateViewCartResponse(sender_psid);\n      }\n    }\n\n    if (response === null) {\n      return defaultResponse();\n    }\n\n    return response;\n  } else if (is_greeting) {\n    // Message has no intent, just greeting\n    return generateResponseFromMessage(\n      \"Hi there! Welcome to MINDS. How can I help you?\"\n    );\n  }\n\n  Object.keys(entities).forEach(key => {\n    console.log(key);\n    console.log(entities[key]);\n  });\n\n  return defaultResponse();\n}\n\nfunction defaultResponse() {\n  return generateResponseFromMessage(\n    \"We could not understand your message. Kindly rephrase your message and send us again.\"\n  );\n}\n\nfunction generateResponseFromMessage(message) {\n  return {\n    text: message\n  };\n}\n\nfunction generateRecommendationsTemplateElements(products) {\n  let template_elements = products.map(product => {\n    return {\n      title: product[\"name\"],\n      subtitle: `$${product[\"price\"]}`,\n      image_url: product[\"url\"],\n      buttons: [\n        {\n          type: \"postback\",\n          title: \"Learn More\",\n          payload: `enquiry_product ${product[\"name\"]}`\n        },\n        {\n          type: \"postback\",\n          title: \"Add to Cart\",\n          payload: `cart_add ${product[\"name\"]}`\n        }\n      ]\n    };\n  });\n  return template_elements;\n}\n\nfunction generateRecommendationsResponse(product_types) {\n  let response = {\n    attachment: {\n      type: \"template\",\n      payload: {\n        template_type: \"generic\",\n        elements: generateRecommendationsTemplateElements([\n          {\n            id: 1,\n            name: \"Dark Chocolate Oatmeal Cookies\",\n            price: 3.5,\n            url:\n              \"https://static.wixstatic.com/media/768979_3fccb2bb837a44caa80bb4fc5dddd119~mv2_d_1800_1800_s_2.jpg\",\n            attribute: {\n              allegens: ['eggs', 'nut'],\n              colour: null,\n              \n            }\n          },\n          {\n            id: 2,\n            name: \"Cranberry Sweetheart Cookies (Eggless)\",\n            price: 3.5,\n            url:\n              \"https://static.wixstatic.com/media/768979_3fccb2bb837a44caa80bb4fc5dddd119~mv2_d_1800_1800_s_2.jpg\"\n          },\n          {\n            id: 3,\n            name: \"Earl Grey Sunflower Seeds Cookies\",\n            price: 3.5,\n            url:\n              \"https://static.wixstatic.com/media/768979_3fccb2bb837a44caa80bb4fc5dddd119~mv2_d_1800_1800_s_2.jpg\"\n          }\n        ])\n      }\n    }\n  };\n  return response;\n}\n\nfunction generateAddCartResponse(sender_psid, product_name, quantity) {\n  // TODO: Add product to cart in db\n\n  return {\n    text: `Added ${quantity} ${product_name} to cart.`,\n    quick_replies: [\n      {\n        \"content_type\": \"text\",\n        \"title\": \"View Cart\",\n        \"payload\": `cart_view`\n      },\n      {\n        \"content_type\": \"text\",\n        \"title\": \"Checkout\",\n        \"payload\": `checkout`\n      }\n    ]\n  };\n}\n\nfunction generateCartTemplateElements(products) {\n  let template_elements = products.map(product => {\n    return {\n      title: product[\"name\"],\n      subtitle: `Qty: ${product[\"quantity\"]} ($${product[\"price\"]} each)`,\n      image_url: product[\"url\"],\n      buttons: [\n        {\n          type: \"postback\",\n          title: \"Add 1\",\n          payload: `cart_add ${product[\"name\"]}`\n        },\n        {\n          type: \"postback\",\n          title: \"Remove All\",\n          payload: `cart_remove ${product[\"name\"]}`\n        }\n      ]\n    };\n  });\n  return template_elements;\n}\n\nfunction generateViewCartResponse(product_types) {\n  let response = {\n    attachment: {\n      type: \"template\",\n      payload: {\n        template_type: \"generic\",\n        elements: generateCartTemplateElements([\n          {\n            id: 1,\n            name: \"Dark Chocolate Oatmeal Cookies\",\n            price: 3.5,\n            url:\n              \"https://static.wixstatic.com/media/768979_3fccb2bb837a44caa80bb4fc5dddd119~mv2_d_1800_1800_s_2.jpg\",\n            quantity: 1\n          },\n          {\n            id: 2,\n            name: \"Cranberry Sweetheart Cookies (Eggless)\",\n            price: 3.5,\n            url:\n              \"https://static.wixstatic.com/media/768979_3fccb2bb837a44caa80bb4fc5dddd119~mv2_d_1800_1800_s_2.jpg\",\n            quantity: 2\n          },\n          {\n            id: 3,\n            name: \"Earl Grey Sunflower Seeds Cookies\",\n            price: 3.5,\n            url:\n              \"https://static.wixstatic.com/media/768979_3fccb2bb837a44caa80bb4fc5dddd119~mv2_d_1800_1800_s_2.jpg\",\n            quantity: 1\n          }\n        ])\n      }\n    }\n  };\n  return response;\n}\n\n// Handles messaging_postbacks events\nfunction handlePostback(sender_psid, received_postback) {\n  let response;\n\n  // Get the payload for the postback\n  let payload = received_postback.payload;\n  console.log(`Received postback: \"${payload}\"`);\n\n  let postback_intent = payload.split(\" \")[0];\n  let postback_content = payload.substring(\n    payload.indexOf(\" \") + 1,\n    payload.length\n  );\n\n  // Set the response based on the postback intent\n  if (postback_intent === \"cart_add\") {\n    // Add to cart\n    response = generateAddCartResponse(sender_psid, postback_content, 1);\n  } else if (postback_intent === \"cart_view\") {\n    response = generateViewCartResponse(sender_psid);\n  } else if (postback_intent === \"enquiry_product\") {\n    response = {\n      text: `What would you like to know about our ${postback_content}?`\n    };\n  }\n\n  if (response == null) {\n    response = defaultResponse();\n  }\n\n  // Send the message to acknowledge the postback\n  callSendAPI(sender_psid, response);\n}\n\n// Sends response messages via the Send API\nfunction callSendAPI(sender_psid, response) {\n  // Construct the message body\n  let request_body = {\n    recipient: {\n      id: sender_psid\n    },\n    message: response\n  };\n\n  // Send the HTTP request to the Messenger Platform\n  request(\n    {\n      uri: \"https://graph.facebook.com/v2.6/me/messages\",\n      qs: { access_token: PAGE_ACCESS_TOKEN },\n      method: \"POST\",\n      json: request_body\n    },\n    (err, res, body) => {\n      if (!err) {\n        console.log(\"Message sent!\");\n      } else {\n        console.error(\"Unable to send message:\" + err);\n      }\n    }\n  );\n}\n"
      ]
    },
    "mtime": 1592383248000
  }
}